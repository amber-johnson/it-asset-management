In order to deploy to a new development environment, certain steps must be taken to ensure the application runs correctly.

## Production Server
We currently deploy to an Ubuntu 18.04 image hosted by and AWS EC2 machine. Other machines and linux distributions may be sufficient but are untested. Our server uses Python version 3.6.9. The linux user executing the following commands must have sudo access without a password. This user must have a private key allowing access to gitlab.oit.duke.edu through a GitLab user with access to this repository, which must be set up on the GitLab website. To begin, run the command `git clone git@gitlab.oit.duke.edu:ban20/hyposoft-group-8.git hyposoft-deployed` in the user's home directory. This page assumes the user is `ubuntu`.

## Python
Run the following commands to install and prepare Python on the server.
1. `sudo apt-get install python3-pip`
2. `sudo apt-get install python3`

## uWSGI
Django is served using uWSGI. This needs to be set up on your deployment server using the following commands.
1. Run `sudo pip3 install uwsgi`.
2. Run `sudo apt-get install libpq-dev && pip3 install --no-binary :all: psycopg2`.
3. Create a file (creating directories as necessary) `/etc/uwsgi/vassals/uwsgi.ini` and place the following contents:
```
[uwsgi]
chdir=/home/ubuntu/hyposoft-deployed/app/hyposoft
module=hyposoft.wsgi:application
master=True
processes=10
threads=1
socket=/home/ubuntu/hyposoft.sock
chmod-socket=666
vacuum=True
safe-pidfile=/home/ubuntu/uwsgi.pid
```
3. uWSGI can be run using the command `sudo uwsgi --emperor /etc/uwsgi/vassals/`

Note: uWSGI must be running for the application to be accessible. You can keep it live in the background by using the linux `screen` command: 
* `sudo screen -dmS hyp_scr bash`
* `sudo screen -S hyp_scr -p 0 -X stuff "uwsgi --emperor /etc/uwsgi/vassals/ $(echo -ne '\r')"`

or an alternative of your choice.

## Apache
The application uses a Apache web server to handle requests from clients. The version we use is 2.4.29 for Ubuntu.

1. `sudo apt-get install apache=2.4.*`
The server serves static content generated by `django-admin collectstatic` and proxies all other requests to Django via uWSGI. This connection is made via a Unix Web Socket.

2. Install apache2 module mod-proxy-uwsgi with `sudo apt-get install -y libapache2-mod-proxy-uwsgi`. Enable the module with 
``` bash
sudo a2enmod -m proxy
sudo a2enmod -m proxy_uwsgi
```

3. Update the apache2 config files. A sample apache webserver configuration is below, please adapt to your own needs and write to `/etc/apache2/sites-enabled/000-default.conf`. Make sure to enable https to use the shibboleth features, as Duke Idp sends secure cookies that won't get stored on non-https sites. Also, configure `/etc/apache2/apache2.conf` with appropriate permissions.

### 000-default.conf
``` apache
<VirtualHost *:80>
	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined

	Alias /static /home/gitlab-runner/hyposoft-deployed/app/hyposoft/static

	<Location />
		AuthType shibboleth
		Require shibboleth

		ProxyPass unix:${PATH_TO hyposoft.sock}|uwsgi://hyposoft/
		ProxyPassReverse unix:${PATH_TO hyposoft.sock}|uwsgi://hyposoft/
	</Location>

	<Location /static>
		ProxyPass "!"
	</Location>

	<Location /Shibboleth.sso>
		ProxyPass "!"
	</Location>
</VirtualHost>
```

After saving the files, run the following commands to finish setting up apache webserver.
1. `apachectl -t` to test the configuration for syntax errors
2. `sudo systemctl restart apache2`

## Django
Install required dependencies by running `sudo pip3 install -r requirements.txt` in the hyposoft-deployed project directory.

The Django setup requires that some environment variables be set manually. Add these variables to /etc/bash.bashrc for sudo access, filling in the required information:
```
export DB_HOST="<Your Database Host URL>"
export DB_USER="<Your Database Username>"
export DB_PASS="<Your Database Password>"
export DB_NAME="<Your Database Name>"
export DJANGO_DEBUG=<True or False> # Python syntax, not bash syntax
```
To source these changes, run `sudo -s` followed by `source /etc/bash.bashrc` and `exit` to return to your user.

You may need to run `sudo uwsgi --reload uwsgi.pid` in order to start the Django server.

Lastly, create a Django administrator account for you to use. This can be done by navigating to the project root and using the command `python3 app/hyposoft/manage.py createsuperuser` and following the instructions.

## React
You must build the react files required to run the application client-side. Run the following commands:
1. `sudo apt-get install node npm`
2. `cd /home/ubuntu/hyposoft-deployed/app/hyposoft/frontend/`
3. `npm i`
4. `npm run build`
5. `cd ..`
6. `python3 manage.py collectstatic --no-input`